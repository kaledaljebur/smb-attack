if (-not ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole(`
    [Security.Principal.WindowsBuiltInRole] "Administrator")) {
    Write-Host "Please run this script as Administrator."
    exit
}

Write-Host "Enabling Guest account..."
net user guest /active:yes
net user guest ""

$sharePath = "C:\Sharing"
if (-Not (Test-Path $sharePath)) {
    New-Item -Path $sharePath -ItemType Directory | Out-Null
}

icacls $sharePath /grant "Everyone:(OI)(CI)F" /T

Write-Host "Creating open SMB share..."
New-SmbShare -Name "Sharing" -Path $sharePath -FullAccess "Everyone"

secedit /export /cfg "$env:PUBLIC\deny.inf"

$content = Get-Content "$env:PUBLIC\deny.inf"
$index = $content.IndexOf("[Privilege Rights]")
for ($i = $index + 1; $i -lt $content.Length; $i++) {
    if ($content[$i] -match "^\[.*\]") { break }
    if ($content[$i] -match "^SeDenyNetworkLogonRight") {
        $content[$i] = $content[$i] -replace ",?Guest", ""
    }
}

$content | Set-Content "$env:PUBLIC\deny.inf" -Encoding Unicode
secedit /configure /db "$env:PUBLIC\deny.sdb" /cfg "$env:PUBLIC\deny.inf" /areas USER_RIGHTS


Write-Host "Disabling Windows Defender real-time protection..."
Set-MpPreference -DisableRealtimeMonitoring $true

Write-Host "Disabling Windows Firewall..."
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

Restart-Service lanmanserver -Force
